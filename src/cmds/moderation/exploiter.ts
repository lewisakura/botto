import { CommandContext } from '../../types';
import { discordSnowflakeRegex } from '../../utils/general';

async function exec(ctx: CommandContext) {
    if (ctx.args.length < 1) {
        return ctx.reply(ctx.config.emoji.error + ' You need to mention a user or provide a snowflake.');
    }

    if (ctx.args[0] === '❄️') {
        return ctx.reply(
            ctx.config.emoji.error +
                ' You... provided the wrong type of snowflake. Fine, let me spell it out for you: you need to mention a user or provide a Discord user ID.'
        );
    }

    const userIdRaw = ctx.args[0].match(discordSnowflakeRegex);
    if (!userIdRaw) {
        return ctx.reply(ctx.config.emoji.error + ' You need to mention a user or provide a snowflake.');
    }

    const userId = userIdRaw[1];
    const member = ctx.msg.channel.guild.members.find(m => m.id === userId);
    if (!member) {
        return ctx.reply(ctx.config.emoji.error + ' Could not find user.');
    }

    const targetUserLevel = ctx.getUserStaffLevel(member);
    if (targetUserLevel >= ctx.userStaffLevel) {
        return ctx.reply(
            `${ctx.config.emoji.error} You cannot target someone with a higher or equal staff level to you (target is staff level ${targetUserLevel}, you are staff level ${ctx.userStaffLevel}).`
        );
    }

    if (member.id === ctx.bot.user.id) {
        return ctx.reply(`${ctx.config.emoji.error} ...`);
    }

    if (member.bot) {
        return ctx.reply(`${ctx.config.emoji.error} Are you seriously trying to put my own kind in there?`);
    }

    const remove = ctx.args.length > 1 ? ctx.args[1] === '-r' : false;

    if (member.roles.includes(ctx.config.exploiterRole) && !remove) {
        return ctx.reply(
            ctx.config.emoji.error +
                ' This user is already listed on the exploiter registry!\nDid you want to remove the role? Rerun this command with `-r`.'
        );
    } else if (!member.roles.includes(ctx.config.exploiterRole) && remove) {
        return ctx.reply(ctx.config.emoji.error + " This user isn't on the exploiter registry!");
    }

    if (remove) {
        await member.removeRole(ctx.config.exploiterRole);
        return ctx.reply(
            `${ctx.config.emoji.success} ${member.username}#${member.discriminator} is no longer listed on the exploiter registry.`
        );
    } else {
        await member.addRole(ctx.config.exploiterRole);
        return ctx.reply(
            `${ctx.config.emoji.success} ${member.username}#${member.discriminator} is now listed on the exploiter registry.`
        );
    }
}

export default {
    name: 'exploiter',
    description: "Toggles a user's exploiter status.",
    usage: '<discord user(1)> <-r?>',

    exec,
    level: 1
};
